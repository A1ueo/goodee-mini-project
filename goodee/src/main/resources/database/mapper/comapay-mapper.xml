<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goodee.proj.common.comapay.ComapayDAO">
	<resultMap type="ProductDTO" id="productResultMap">
		<id property="productNumber" column="product_number" />
		<result property="name" column="name" />
		<result property="category" column="category" />
		<result property="amount" column="amount" />
		<result property="price" column="price" />
		
		<association property="productImageDTO" javaType="ProductImageDTO">
			<id property="attachNumber" column="attach_number" />
			<result property="keyData" column="key_data" />
			<result property="type" column="type" />
			<result property="origin" column="origin" />
			<result property="saved" column="saved" />
		</association>
	</resultMap>
	
	<resultMap type="PaymentDTO" id="paymentResultMap">
		<id property="paymentNumber" column="payment_number" />
		<result property="paymentType" column="payment_type" />
		<result property="paymentId" column="payment_id" />
		<result property="orderId" column="order_id" />
		
		<collection property="productDTOs" javaType="java.util.List" resultMap="productResultMap" />
	</resultMap>
	
	<select id="selectCheckedProductList" parameterType="java.util.List" resultMap="productResultMap">
		SELECT
				*
		FROM product P
		INNER JOIN attach A ON A.type = 3 AND P.product_number = A.key_data
		<where>
			<foreach item="item" collection="productNumbers" open="P.product_number IN (" separator="," close=")">
          #{item}
    </foreach>
		</where>
	</select>
	
	<select id="selectOrderList" parameterType="Long" resultMap="paymentResultMap">
		SELECT
				*
		FROM payment PAY
		INNER JOIN orders O USING (payment_number)
		INNER JOIN product P ON O.product_number = P.product_number
		INNER JOIN attach A ON A.type = 3 AND P.product_number = A.key_data
		<where>
			O.account_number = #{accountNumber}
		</where>
	</select>
	
	<insert id="insertPayment" parameterType="PaymentDTO" useGeneratedKeys="true" keyProperty="paymentNumber">
		INSERT INTO payment
		VALUES (NULL, #{paymentType}, #{paymentId}, #{orderId})
	</insert>
	
	<insert id="insertOrder" parameterType="OrderDTO">
		INSERT INTO orders
		VALUES
		<foreach collection="productNumbers" item="productNum" separator=",">
			(NULL, #{accountNumber}, #{productNum}, #{paymentNumber})
		</foreach>
	</insert>
	
	<select id="selectPayment" parameterType="PaymentDTO" resultType="PaymentDTO">
		SELECT *
		FROM payment
		WHERE payment_number = #{paymentNumber}
	</select>
</mapper>